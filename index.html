        async function submitForm(btn) {
            if(!document.getElementById('agreeCheck').checked) {
                showToast('請詳閱並同意服務條款', false);
                const label = document.getElementById('agreeLabel');
                label.classList.add('animate-bounce');
                setTimeout(()=> label.classList.remove('animate-bounce'), 1000);
                return;
            }

            if(!validateForm()) return;

            const originalContent = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i><span class="ml-2">傳送中...</span>`;
            btn.disabled = true;
            btn.classList.add('opacity-80', 'cursor-not-allowed');
            lucide.createIcons();

            try {
                const formData = {
                    owner_name: document.getElementById('ownerName').value,
                    owner_email: document.getElementById('ownerEmail').value,
                    owner_id: document.getElementById('ownerId').value,
                    owner_phone: document.getElementById('ownerPhone').value,
                    owner_address: document.getElementById('ownerAddress').value,
                    emergency_name: document.getElementById('emergencyName').value,
                    emergency_phone: document.getElementById('emergencyPhone').value,
                    hospital: document.getElementById('hospital').value,

                    pet_name: document.getElementById('petName').value,
                    pet_breed: document.getElementById('petBreed').value,
                    pet_color: document.getElementById('petColor').value,
                    pet_age: parseInt(document.getElementById('petAge').value) || 0,
                    
                    pet_chip: (function(){
                        const status = document.getElementById('chipStatus').value;
                        if(status === 'no_chip') return '無晶片';
                        if(status === 'unknown') return '號碼不詳';
                        return document.getElementById('petChip').value;
                    })(),

                    pet_sex: document.querySelector('input[name="petSex"]:checked')?.value,
                    is_neutered: document.querySelector('input[name="isNeutered"]:checked')?.value,
                    is_friendly: document.querySelector('input[name="isFriendly"]:checked')?.value,
                    is_dog_friendly: document.querySelector('input[name="isDogFriendly"]:checked')?.value,
                    is_aggressive: document.querySelector('input[name="isAggressive"]:checked')?.value,
                    has_history: document.querySelector('input[name="hasHistory"]:checked')?.value,
                    
                    service_type: document.querySelector('input[name="serviceType"]:checked')?.value,
                    pickup_time: document.getElementById('pickupTime').value,
                    signature_data: document.getElementById('sign-preview').src,
                    risk_factors: (window.riskReasons || []).join(',')
                };

                // ★ 這裡改用 sbClient
                const { error } = await sbClient.from('service_contracts').insert([formData]);

                if (error) throw error;

                showToast('契約傳送成功！');
                btn.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5"></i><span class="ml-2">完成</span>`;
                btn.classList.replace('bg-gradient-lux', 'bg-green-500');
                
                setTimeout(() => {
                    router('home');
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    btn.classList.remove('opacity-80', 'cursor-not-allowed', 'bg-green-500');
                    btn.classList.add('bg-gradient-lux');
                    
                    document.getElementById('petForm').reset();
                    clearSignature();
                    
                    document.getElementById('btn-risk').classList.add('hidden');
                    document.getElementById('btn-risk').classList.remove('flex');
                    document.getElementById('agreeLabel').querySelector('span').innerText = "本人已詳閱並同意以上契約條款";
                    readStatus = { general: false, risk: false };
                    isHighRisk = false;
                    updateButtonUI('general', false);
                    updateButtonUI('risk', false);
                    checkAllRead();
                }, 1500);

            } catch (err) {
                console.error('Submit Error:', err);
                showToast('傳送失敗: ' + err.message, false);
                btn.innerHTML = originalContent;
                btn.disabled = false;
                btn.classList.remove('opacity-80', 'cursor-not-allowed');
                lucide.createIcons();
            }
        }
